{% extends "learning/base.html" %}
{% block htmx %}
<script src="https://unpkg.com/htmx.org@1.9.12" defer></script>
{% endblock %}

{% block bootstrap_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}

{% block title %}{{ book.title }} ‚Ä¢ Reader{% endblock %}

{% block content %}
<div class="d-flex justify-content-between mb-3">
  <h1 class="h4">{{ book.title }}</h1>
  {% if user_audio %}
    <audio controls src="{{ user_audio.audio_file.url }}" style="max-width:300px;"></audio>
  {% endif %}
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <div id="reader" class="reader-content">
      {% for s in sentences %}
        <span class="sentence" data-sentence="{{ s.text|escapejs }}">
          {% for tk in s.tokens %}
            {% if tk.type == "word" %}
              <span class="word-token" data-word="{{ tk.text }}">{{ tk.text }}</span>
            {% elif tk.type == "space" %}
              <span class="gap"
                    data-sentence="{{ s.text|escapejs }}"
                    hx-post="{% url 'learning:translate_word_htmx' %}"
                    hx-vals='js:{word:this.closest(".sentence").dataset.sentence}'
                    hx-target="#translationModal .modal-content"
                    hx-swap="innerHTML">{{ tk.text }}</span>
            {% else %}
              <span class="punct">{{ tk.text }}</span>
            {% endif %}
          {% endfor %}
        </span>
      {% endfor %}
    </div>
  </div>
</div>

<div class="d-flex justify-content-between mb-3 align-items-center">
  {% if not user_audio %}
    <div>
      <h1 class="h4 mb-1">{{ book.title }}</h1>
      <div class="text-secondary small">Level: {{ book.level }}</div>
    </div>
    <a href="{% url 'learning:generate_audio_for_book' book.id %}" class="btn btn-success">
      üéß Generate Audio
    </a>
  {% endif %}
</div>
{% endblock %}

{% block head %}
<style>
  .reader-content { line-height:1.8; font-size:1.05rem; }
  .word-token { cursor:pointer; padding:0 .15rem; border-radius:.2rem; transition:background .15s,color .15s; }
  .word-token:hover { background:rgba(13,110,253,.12); color:#0d6efd; }
  .gap { cursor:pointer; }
  .sentence.sentence-highlight { background:rgba(25,135,84,.1); }
</style>
{% endblock %}

{% block scripts %}
<script>
(function(){
  function getCookie(name){
    const v = `; ${document.cookie}`;
    const p = v.split(`; ${name}=`);
    if(p.length === 2) return p.pop().split(';').shift();
  }
  document.addEventListener('htmx:configRequest', e => {
    const t = getCookie('csrftoken');
    if(t) e.detail.headers['X-CSRFToken'] = t;
  });

  const reader = document.getElementById('reader');
  const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  if(!isTouch){
    reader.querySelectorAll('.gap').forEach(gap=>{
      gap.addEventListener('mouseover',()=>{
        const s = gap.closest('.sentence');
        if(s) s.classList.add('sentence-highlight');
      });
      gap.addEventListener('mouseout',()=>{
        const s = gap.closest('.sentence');
        if(s) s.classList.remove('sentence-highlight');
      });
    });
  }

  reader.querySelectorAll('.word-token').forEach(el=>{
    const w = el.dataset.word;
    const content = `<div class="d-flex gap-2 align-items-center">
      <span class="small text-secondary">${w}</span>
      <button type="button" class="btn btn-primary btn-sm" data-translate-word="${w}">Translate</button>
    </div>`;
    new bootstrap.Popover(el, {
      trigger: 'click',
      html: true,
      placement: 'top',
      content: content,
      sanitize: false
    });

    el.addEventListener('click', ()=>{
      document.querySelectorAll('.word-token').forEach(other=>{
        if(other !== el){
          const pop = bootstrap.Popover.getInstance(other);
          if(pop) pop.hide();
        }
      });
    });
  });

  document.addEventListener('click',(e)=>{
    if(!e.target.closest('.word-token') && !e.target.closest('.popover')){
      document.querySelectorAll('.word-token').forEach(el=>{
        const pop = bootstrap.Popover.getInstance(el);
        if(pop) pop.hide();
      });
    }
  });

  // ‚úÖ TRANSLATION BUTTON IN POPOVER
  document.addEventListener('click', function(e){
    const btn = e.target.closest('[data-translate-word]');
    if (!btn) return;

    const word = btn.getAttribute('data-translate-word');

    // Close all popovers
    document.querySelectorAll('.word-token').forEach(el => {
      const pop = bootstrap.Popover.getInstance(el);
      if (pop) pop.hide();
    });

    // Show loading content in modal
    const modalContent = document.querySelector('#translationModal .modal-content');
    modalContent.innerHTML = `
      <div class="modal-header">
        <h5 class="modal-title">Translating ‚Äú${word}‚Äù</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center py-5">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <div class="small text-secondary">Loading translation from Gemini...</div>
      </div>
    `;

    const modal = new bootstrap.Modal(document.getElementById('translationModal'));
    modal.show();

    // ‚úÖ Send actual HTMX request to Gemini translation
    htmx.ajax('POST', "{% url 'learning:translate_word_htmx' %}", {
      values: { word },
      target: "#translationModal .modal-content",
      swap: "innerHTML"
    });
  });
})();
</script>
{% endblock %}